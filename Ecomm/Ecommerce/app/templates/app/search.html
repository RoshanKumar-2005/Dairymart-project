{% extends 'app/base.html' %}
{% load static %}
{% block title %}Search Results{% endblock title %}

{% block main-content %}
<div class="container my-5">
    <h2 class="text-center mb-4">Search Results for "{{ query }}"</h2>

    <div class="row">
        {% if products %}
            {% for p in products %}
            <div class="col-md-4 col-sm-6 mb-4">
                <div class="card text-center shadow-sm p-3 rounded-3 h-100">
                    <a href="{% url 'category' p.category %}">
                        <img src="{{ p.product_image.url }}" class="img-fluid" alt="{{ p.title }}">
                    </a>
                    <div class="card-body">
                        <h5 class="card-title">{{ p.title }}</h5>
                        <p class="fw-bold text-success mb-1">‚Çπ{{ p.discounted_price }}</p>
                        <p class="text-muted"><del>‚Çπ{{ p.selling_price }}</del></p>
                        <div class="d-flex justify-content-center gap-2 mt-2">
                            <a href="{% url 'add_to_cart' p.id %}" class="btn btn-sm btn-primary">üõí Add to Cart</a>
                            {% if p.id in wishlist_items %}
                                <button class="btn btn-sm btn-danger toggle-wishlist" data-product="{{ p.id }}">‚ù§Ô∏è</button>
                            {% else %}
                                <button class="btn btn-sm btn-outline-danger toggle-wishlist" data-product="{{ p.id }}">‚ô°</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12 text-center">
                <p class="text-muted">No products found for your search.</p>
            </div>
        {% endif %}
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
  $(document).on("click", ".toggle-wishlist", function (e) {
    e.preventDefault();
    const button = $(this);
    const productId = button.data("product");

    $.ajax({
      url: "{% url 'toggle_wishlist' %}",
      method: "POST",
      data: {
        product_id: productId,
        csrfmiddlewaretoken: "{{ csrf_token }}",
      },
      success: function (response) {
        if (response.status === "added") {
          button.removeClass("btn-outline-danger").addClass("btn-danger").text("‚ù§Ô∏è");
        } else if (response.status === "removed") {
          button.removeClass("btn-danger").addClass("btn-outline-danger").text("‚ô°");
        }
      },
      error: function () {
        alert("Please login to use wishlist.");
      },
    });
  });
</script>
{% endblock main-content %}
